name: Create a new Release

on:
  push:
    tags: ["release/*"]

permissions:
  contents: write
  pull-requests: read

jobs:
  generate-manifest:
    runs-on: ubuntu-latest
    env:
      BUNDLE_NAME: sparrow-client-update.tar.gz
      CLIENT_FOLDER: ${{ github.workspace }}
      SCRIPT_FOLDER: ${{ github.workspace }}/github_scripts/release_workflow
      STAGING_FOLDER: ${{ github.workspace }}/sparrow-update-staging

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Determine release version 
        id: version
        run: |
          chmod +x "${SCRIPT_FOLDER}/get_version.sh"
          "${SCRIPT_FOLDER}/get_version.sh"

      - name: Determine previous release tag
        id: previous
        run: |
          set -euo pipefail
          previous=""
          while IFS= read -r tag; do
            if [[ "${tag}" != "${GITHUB_REF_NAME}" ]]; then
              previous="${tag}"
              break
            fi
          done < <(git tag --sort=-creatordate "release/*" || true)
          echo "previous-tag=${previous}" >> "${GITHUB_OUTPUT}"

      - name: Generate manifest.json
        run: |
          chmod +x "${SCRIPT_FOLDER}/generate_manifest.sh"
          "${SCRIPT_FOLDER}/generate_manifest.sh"
        env:
          SPARROW_DIR: ${{ env.CLIENT_FOLDER }}

      - name: Copy required folders into staging
        run: |
          rm -rf "${STAGING_FOLDER}"
          mkdir -p "${STAGING_FOLDER}"
          cp "${CLIENT_FOLDER}/manifest.json" "${STAGING_FOLDER}/"
          rsync -a "${CLIENT_FOLDER}/sparrow/" "${STAGING_FOLDER}/sparrow/"
          rsync -a "${CLIENT_FOLDER}/starlink/" "${STAGING_FOLDER}/starlink/"

      - name: Archive staged files
        run: |
          mkdir -p "${GITHUB_WORKSPACE}/artifacts"
          tar -czf "${GITHUB_WORKSPACE}/artifacts/${BUNDLE_NAME}" \
            -C "${STAGING_FOLDER}" .

      - name: Create GitHub release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.version.outputs.release-version }}
          name: Release ${{ steps.version.outputs.release-version }}
          artifacts: artifacts/${{ env.BUNDLE_NAME }}
          commit: ${{ github.sha }}
          artifactErrorsFailBuild: true
          allowUpdates: true
          generateReleaseNotes: true
          generateReleaseNotesPreviousTag: ${{ steps.previous.outputs.previous-tag }}
          prerelease: ${{ contains(steps.version.outputs.release-version, '-alpha') || contains(steps.version.outputs.release-version, '-beta') }}